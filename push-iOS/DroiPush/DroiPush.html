<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>消息推送</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="0dh1" id="消息推送">消息推送</h1><div class="md-section-divider"></div><h2 data-anchor-id="7jvs" id="简介">简介</h2><p data-anchor-id="jqyq">卓易推送（DroiPush）SDK是面向iOS开发者提供的一种消息推送服务模块，应用开发者可以通过第三方服务器或者卓易推送管理后台向集成SDK的应用推送消息，减少开发者集成APNs需要的工作量，并降低开发复杂度，同时还能统计推送的各项数据。</p><p data-anchor-id="09iy"><img src="http://baastest.droi.cn/Uploads/DocFile/5767a6d983ce9.jpeg" alt="推送结构框图"></p><div class="md-section-divider"></div><h2 data-anchor-id="hwv2" id="安装">安装</h2><div class="md-section-divider"></div><h3 data-anchor-id="jhqc" id="开发环境">开发环境</h3><ul data-anchor-id="l01k">
<li>操作系统：Mac OS X等</li>
<li>开发工具：Xcode 6.x 及以上版本</li>
<li>iOS版本：需要iOS 8.0及以上系统</li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="auhe" id="项目配置">项目配置</h3><p data-anchor-id="3ygd">为了更好的支持SDK推送，需要配置后台运行权限：推送唤醒（静默推送，Silent Remote Notifications）如下图：</p><p data-anchor-id="uyda"><img src="http://baastest.droi.cn/Uploads/DocFile/5767a6d394a2a.jpeg" alt="项目配置图"></p><div class="md-section-divider"></div><h3 data-anchor-id="p5tj" id="使用cocoapods方式安装推荐">使用CocoaPods方式安装（推荐）</h3><p data-anchor-id="6zm2">DroiPush SDK使用CocoaPods作为函数库的管理工具。我们推荐您使用CocoaPods这种方式来安装SDK，这样可以大大简化安装DroiPush SDK的流程。如果您未安装CocoaPods，请参考《CocoaPods安装和使用教程》完成安装。CocoaPods安装完成后，在您的项目根目录下创建一个Podfile文件，并添加如下内容：</p><pre data-anchor-id="w9g1"><code>pod  'DroiPush'
</code></pre><p data-anchor-id="5ivl">在控制台中cd到Podfile文件所在目录，执行如下命令完成安装。</p><pre data-anchor-id="71nl"><code>pod  install
</code></pre><div class="md-section-divider"></div><h3 data-anchor-id="ofjm" id="手动安装">手动安装</h3><div class="md-section-divider"></div><h4 data-anchor-id="krpj" id="1-安装droicore-sdk">1. 安装DroiCore SDK</h4><p data-anchor-id="xu9f">由于DroiPush SDK依赖于DroiCore SDK，所以请在安装DroiPush SDK之前仔细阅读<a href="http://baastest.droi.cn/Index/docStart.html" target="_blank">快速入门</a> ，完成DroiCore SDK的安装。</p><div class="md-section-divider"></div><h4 data-anchor-id="8g1w" id="2-导入sdk到应用程序项目">2. 导入SDK到应用程序项目</h4><p data-anchor-id="nqmt">将SDK包解压，在XCode中选择”Add files to 'Your project name’…”，将解压后的DroiPushLib文件夹中的<code>DroiPush.framework</code>添加到你的工程目录中。</p><div class="md-section-divider"></div><h4 data-anchor-id="3e1h" id="3-添加必要的框架">3. 添加必要的框架</h4><p data-anchor-id="je75">点击<code>Build Phases</code>选项，在<code>Link Binary With Libraries</code>中添加以下内容： <br>
* Foundation.framework <br>
* UIKit.framework</p><div class="md-section-divider"></div><h2 data-anchor-id="r7jt" id="使用">使用</h2><div class="md-section-divider"></div><h3 data-anchor-id="58lo" id="初始化droipush-sdk">初始化DroiPush SDK</h3><p data-anchor-id="m9um">在使用DroiPush SDK之前需要先初始化DroiPush SDK 请在Applegate.m中添加如下代码，完成初始化。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ob9r"><ol class="linenums"><li class="L0"><code><span class="com">#import &lt;DroiPush.h&gt;//导入DroiPush.h</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">BOOL</span><span class="pun">)</span><span class="pln">application</span><span class="pun">:(</span><span class="typ">UIApplication</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">application didFinishLaunchingWithOptions</span><span class="pun">:(</span><span class="typ">NSDictionary</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">launchOptions</span></code></li><li class="L3"><code><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">//初始化DroiPush SDK并注册远程推送服务</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> registerForRemoteNotifications</span><span class="pun">];</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> YES</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pun">}</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">application</span><span class="pun">:(</span><span class="typ">UIApplication</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">application didRegisterForRemoteNotificationsWithDeviceToken</span><span class="pun">:(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">deviceToken</span></code></li><li class="L0"><code><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> registerDeviceToken</span><span class="pun">:</span><span class="pln">deviceToken</span><span class="pun">];</span></code></li><li class="L2"><code><span class="pun">}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">application</span><span class="pun">:(</span><span class="typ">UIApplication</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">application didReceiveRemoteNotification</span><span class="pun">:(</span><span class="pln">nonnull </span><span class="typ">NSDictionary</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">userInfo fetchCompletionHandler</span><span class="pun">:(</span><span class="pln">nonnull </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(^)(</span><span class="typ">UIBackgroundFetchResult</span><span class="pun">))</span><span class="pln">completionHandler</span></code></li><li class="L5"><code><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> handleRemoteNotification</span><span class="pun">:</span><span class="pln">userInfo</span><span class="pun">];</span></code></li><li class="L7"><code><span class="pln">    completionHandler</span><span class="pun">(</span><span class="typ">UIBackgroundFetchResultNewData</span><span class="pun">);</span></code></li><li class="L8"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="lyxr" id="标签功能">标签功能</h3><p data-anchor-id="ei4s">开发者可以通过SDK提供的接口为应用设置）标签，便于按照标签分组推送.需要注意的是SDK提供的设置标签接口每次调用的时候都会覆盖上一次的标签。</p><ul data-anchor-id="gxfg">
<li>过滤标签</li>
</ul><p data-anchor-id="o131">过滤掉无效的 tags tag值不能重复,且只能以字母（区分大小写）、数字、下划线、汉字组成如果tags数量超过限制数量（1000）, 则返回靠前的有效的tags.建议设置tags前用此接口校验.SDK内部也会基于此接口来做过滤.</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8h47"><ol class="linenums"><li class="L0"><code><span class="typ">NSSet</span><span class="pln"> </span><span class="pun">*</span><span class="pln">tags </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">NSSet</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithObjects</span><span class="pun">:@</span><span class="str">"tag1"</span><span class="pun">,@</span><span class="str">"tag_2"</span><span class="pun">,@</span><span class="str">"标签3"</span><span class="pun">,@</span><span class="str">"tag!4"</span><span class="pun">,@</span><span class="str">""</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">];</span></code></li><li class="L1"><code><span class="typ">NSSet</span><span class="pln"> </span><span class="pun">*</span><span class="pln">validTags </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> filterValidTags</span><span class="pun">:</span><span class="pln">tags</span><span class="pun">];</span></code></li></ol></pre><ul data-anchor-id="fyso">
<li>设置标签 </li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="a4lu"><ol class="linenums"><li class="L0"><code><span class="typ">NSSet</span><span class="pln"> </span><span class="pun">*</span><span class="pln">tags </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">NSSet</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithObjects</span><span class="pun">:@</span><span class="str">"DroiPush"</span><span class="pun">,@</span><span class="str">"iOS"</span><span class="pun">,</span><span class="kwd">nil</span><span class="pun">];</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> setTags</span><span class="pun">:</span><span class="pln">tags</span><span class="pun">];</span></code></li></ol></pre><ul data-anchor-id="osxp">
<li>清空标签</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mts9"><ol class="linenums"><li class="L0"><code><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> resetTags</span><span class="pun">];</span></code></li></ol></pre><p data-anchor-id="eq9x"><strong>注意：设置标签为[NSSet set]空集合，表示为清空当前设置，也可以调用resetTags接口清空标签。应用tag数量最多限制为1024个，每个长度最多为256字符。</strong> </p><div class="md-section-divider"></div><h3 data-anchor-id="htit" id="设置角标">设置角标</h3><p data-anchor-id="nedz">badge（角标）是iOS用来标记应用程序状态的一个数字，出现在程序图标右上角。sdk封装badge功能，允许应用上传badge值至DroiPush服务器，由DroiPush后台帮助开发者管理每个用户所对应的推送badge值，简化了设置推送badge的操作。实际应用中，开发者只需将变化后的badge值通过setBadge接口同步DroiPush服务器，无需自己维护用户与badge值之间的对应关系，方便运营维护。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ilt7"><ol class="linenums"><li class="L0"><code><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> setBadge</span><span class="pun">:</span><span class="lit">0</span><span class="pun">];</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="j0pg" id="接收长消息与文件">接收长消息与文件</h3><p data-anchor-id="9jkk">DroiPush SDK 提供了接收长消息和文件通知的功能。</p><ul data-anchor-id="kwpm">
<li>长消息通知</li>
</ul><p data-anchor-id="vlkw">由于苹果官方规定APNs推送payload的大小最大为4K，当开发者需要推送的payload超过4K大小时，DroiPush会自动将消息转换为长消息类型供开发者使用；</p><ul data-anchor-id="1f2j">
<li>文件推送</li>
</ul><p data-anchor-id="vte2">DroiPush支持开发者上传自定义文件,或者使用外部文件(文件url)，通过通知推送到应用。  </p><p data-anchor-id="x8sd"><code>kDroiPushReceiveLongMessageNotification</code> (收到长消息通知)  </p><p data-anchor-id="sh2v"><code>kDroiPushReceiveFileNotification</code> (收到文件通知)</p><p data-anchor-id="5x3l">开发者可以通过通知中心监听通知,根据需求对接收到的消息进行处理。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="erg1"><ol class="linenums"><li class="L0"><code><span class="com">//添加监听</span></code></li><li class="L1"><code><span class="pun">[[</span><span class="typ">NSNotificationCenter</span><span class="pln"> defaultCenter</span><span class="pun">]</span><span class="pln"> addObserver</span><span class="pun">:</span><span class="kwd">self</span></code></li><li class="L2"><code><span class="pln">                                             selector</span><span class="pun">:</span><span class="lit">@selector</span><span class="pun">(</span><span class="pln">receiveLongMessage</span><span class="pun">:)</span></code></li><li class="L3"><code><span class="pln">                                                 name</span><span class="pun">:</span><span class="pln">kDroiPushReceiveLongMessageNotification</span></code></li><li class="L4"><code><span class="pln">                                               </span><span class="kwd">object</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">];</span></code></li></ol></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="24cw"><ol class="linenums"><li class="L0"><code><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">receiveLongMessage</span><span class="pun">:(</span><span class="typ">NSDictionary</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">dict</span></code></li><li class="L1"><code><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">    </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"receiveLongMessage:%@"</span><span class="pun">,</span><span class="pln">dict</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="irkl" id="log功能开关">Log功能开关</h3><p data-anchor-id="ohqy">建议开发者在发布应用前关闭DroiPush的Log功能，节省系统资源。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="r0u3"><ol class="linenums"><li class="L0"><code><span class="com">//关闭Log功能,默认为开启</span></code></li><li class="L1"><code><span class="pun">[</span><span class="typ">DroiPush</span><span class="pln"> setLogOFF</span><span class="pun">:</span><span class="pln">YES</span><span class="pun">];</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="akwv" id="faq">FAQ</h2><div class="md-section-divider"></div><h3 data-anchor-id="x1a2" id="droipush-的作用与特点">DroiPush 的作用与特点？</h3><ul data-anchor-id="3dxo">
<li>降低开发成本</li>
</ul><p data-anchor-id="awex">iOS 平台上，只有 APNs 这个官方的推送通道，是可以随时送达的。一般开发者都是自己部署应用服务器向 APNs Server 推送。DroiPush只需开发者做一些简单的SDK移植接入工作，就可在短期内使应用具有接收推送消息的功能，免去了开发者额外投入大量人力、服务器资源，将主要精力投入在核心业务的开发上。</p><ul data-anchor-id="add4">
<li>丰富的消息类型</li>
</ul><p data-anchor-id="r7nl">DroiPush提供了多种消息类型推送，包含有普通通知、静默通知、长消息通知、以及文件推送，满足用户消息推送的多样化需求。</p><ul data-anchor-id="wqpq">
<li>精准的用户分群</li>
</ul><p data-anchor-id="t4cd">DroiPush提供了标签绑定功能，开发者可以根据业务需求为用户绑定多种标签,细分用户分群，使得运营更加简单、直观。</p><div class="md-section-divider"></div><h3 data-anchor-id="n1lx" id="droipush-支持哪些通知类型">DroiPush 支持哪些通知类型？</h3><p data-anchor-id="i3qi">DroiPush提供了普通通知、透传消息、长消息通知、以及文件推送。</p><ul data-anchor-id="kr31">
<li>普通通知</li>
</ul><p data-anchor-id="9s28">最基础的通知类型，当应用不在前台状态时会在通知栏或者锁屏页面显示；</p><ul data-anchor-id="qkqz">
<li>透传消息</li>
</ul><p data-anchor-id="pec8">应用收到透传消息系统不会有任何提示，开发者可以使用它后台刷新数据(需要先配置Background Modes)；</p><ul data-anchor-id="65f0">
<li>长消息通知</li>
</ul><p data-anchor-id="syn6">由于苹果官方规定APNs推送payload的大小最大为4K，当开发者需要推送的payload超过4K大小时，DroiPush会自动将消息转换为长消息类型供开发者使用；</p><ul data-anchor-id="eysj">
<li>文件推送</li>
</ul><p data-anchor-id="qy3m">DroiPush支持开发者上传自定义文件,或者使用外部文件(文件url)，通过通知推送到应用。</p><div class="md-section-divider"></div><h3 data-anchor-id="vys0" id="droipush可以对推送的数据进行统计吗">DroiPush可以对推送的数据进行统计吗？</h3><p data-anchor-id="p0dp">开发者可以在推送平台上查看推送统计数据，对推送的数据进行分析。以下是推送数据统计的指标：</p><ul data-anchor-id="014y">
<li>已推送消息数：单播消息、组播消息和群发消息数；</li>
<li>送达消息数：已经接收到消息的数量(iOS由于系统封闭，只能统计消息送达APNs的数量)；</li>
<li>通知点击数：用户通过通知栏中通知点击打开应用的次数；</li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="fmz0" id="droipush-支持哪些推送方式">DroiPush 支持哪些推送方式？</h3><p data-anchor-id="gjls">DroiPush支持单播、列播、组播、群播的方法选择推送目标。</p><ul data-anchor-id="p0z8">
<li>单播</li>
</ul><p data-anchor-id="z082">推送平台可以通过deviceId指定单个目标进行推送；</p><ul data-anchor-id="2vsz">
<li>列播</li>
</ul><p data-anchor-id="hwog">推送平台可以通过deviceId列表指定多个目标进行推送；</p><ul data-anchor-id="8f2z">
<li>组播</li>
</ul><p data-anchor-id="u6d6">SDK提供接口给应用打标签，推送时开发者选定推送目标为对应标签，推送服务器则向该标签的分组用户推送消息；</p><ul data-anchor-id="xer5">
<li>群播</li>
</ul><p data-anchor-id="g83o">推送服务器向该应用的所有用户推送消息。</p><div class="md-section-divider"></div><h3 data-anchor-id="cqd4" id="droipush的推送性能如何">DroiPush的推送性能如何？</h3><p data-anchor-id="dx1m">为了保证推送服务的质量，我们在实验环境下对服务器进行压力测试，得到的性能参数如下：</p><ul data-anchor-id="r1er">
<li>同时连接数：同时链接数支持超过1000万；</li>
<li>并发推送数：同时并发推送数支持超过100万；</li>
<li>及时性：100万条数据同时推送出去延时不超过30S；</li>
<li>连接稳定性：连接成功率超过99%（排除网络原因）。</li>
</ul></div>
</body>
</html>